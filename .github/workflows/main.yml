# GitHub Actions å®Œæ•´éƒ¨ç½²æµç¨‹
name: Deploy RShiny App with Azure AD Auth + KeyVault
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: "r-shiny-rg"
  LOCATION: "australiasoutheast"
  ACR_NAME: "rshinycr"
  ACR_LOGIN_SERVER: "rshinycr.azurecr.io"
  APP_SERVICE_PLAN: "shiny-plan"
  WEBAPP_NAME: "shiny-web-app"
  KEYVAULT_NAME: "my-shiny-keyvault"
  SECRET_NAME: "aad-client-secret"
  IMAGE_NAME: "shinyapp"
  AAD_CLIENT_ID: ${{ secrets.AAD_CLIENT_ID }}
  AAD_ISSUER_URL: "https://sts.windows.net/${{ secrets.AZURE_TENANT_ID }}/"
  TOKEN_AUDIENCE: "api://${{ secrets.AAD_CLIENT_ID }}"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build and push Docker image
      run: |
        echo "ğŸ³ æ„å»ºå¹¶æ¨é€Dockeré•œåƒåˆ° $ACR_LOGIN_SERVER"
        az acr login --name $ACR_NAME
        docker build -t $ACR_LOGIN_SERVER/$IMAGE_NAME:latest .
        docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:latest

    - name: Update container settings for App Service
      run: |
        echo "ğŸ”„ æ›´æ–°Web Appçš„å®¹å™¨è®¾ç½®"
        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --docker-custom-image-name $ACR_LOGIN_SERVER/$IMAGE_NAME:latest \
          --docker-registry-server-url https://$ACR_LOGIN_SERVER

    - name: Configure Key Vault references in App Service
      run: |
        echo "ğŸ”‘ é…ç½®App Serviceä½¿ç”¨Key Vaultå¼•ç”¨"
        # è®¾ç½®åº”ç”¨ç¨‹åºé…ç½®ä»¥ä½¿ç”¨Key Vaultå¼•ç”¨
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --settings \
            "AAD_CLIENT_SECRET=@Microsoft.KeyVault(SecretUri=https://$KEYVAULT_NAME.vault.azure.net/secrets/$SECRET_NAME/)"

    - name: Configure Azure AD Authentication
      run: |
        echo "ğŸ” é…ç½®Azure ADè®¤è¯"
        # ä»KeyVaultè·å–ç³»ç»Ÿæ‰˜ç®¡èº«ä»½çš„æƒé™å·²åœ¨setupè„šæœ¬ä¸­è®¾ç½®
        az webapp auth update \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --enabled true \
          --action LoginWithAzureActiveDirectory \
          --aad-client-id $AAD_CLIENT_ID \
          --aad-token-issuer-url $AAD_ISSUER_URL \
          --aad-allowed-token-audiences $TOKEN_AUDIENCE

    - name: Restart App Service
      run: |
        echo "ğŸ”„ é‡å¯App Serviceä»¥åº”ç”¨æ›´æ”¹"
        az webapp restart --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP

    - name: Verify deployment
      run: |
        echo "âœ… éªŒè¯éƒ¨ç½²"
        APP_URL=$(az webapp show --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP --query defaultHostName -o tsv)
        echo "åº”ç”¨å·²éƒ¨ç½²åˆ°: https://$APP_URL"
        # ç­‰å¾…åº”ç”¨å¯åŠ¨
        sleep 30
        # å°è¯•è®¿é—®åº”ç”¨å¥åº·æ£€æŸ¥ç«¯ç‚¹
        curl -s -o /dev/null -w "%{http_code}" https://$APP_URL/health || echo "åº”ç”¨å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´å¯åŠ¨"